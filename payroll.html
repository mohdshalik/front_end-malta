<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Boxicons -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <link href='https://unpkg.com/boxicons@2.1.4/dist/boxicons.js' rel='stylesheet'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <!-- Download pdf format -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- My CSS -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="astyle.css">

  <link rel="stylesheet" href="new.css">
  <link rel="stylesheet" href="new.css">


  <script src="ascript.js"></script>


  <title>Dashboard</title>
</head>

<body>
  <!-- SIDEBAR -->
  <section id="sidebar">
    <a href="#" class="brand">
      <i class='bx bxs-smile  bx-lg'></i>
      <span class="text">Company</span>
    </a>
    <ul class="side-menu top">
      <li>
        <a href="dashboard.html">
          <i class='bx bxs-dashboard bx-sm'></i>
          <span class="text">Dashboard</span>
        </a>
      </li>
      <li>
        <a href="company-master.html">
          <i class='bx bxs-shopping-bag-alt bx-sm'></i>
          <span class="text">Company</span>
        </a>
      </li>
      <li>
        <a href="department-master.html">
          <i class='bx bxs-doughnut-chart bx-sm'></i>
          <span class="text">Department</span>
        </a>
      </li>
      <li>
        <a href="role.html">
          <i class='bx bxs-group bx-sm'></i>
          <span class="text">Designation Master</span>
        </a>
      </li>
      <li>
        <a href="category.html">
          <i class='bx bxs-group bx-sm'></i>
          <span class="text">Category Master</span>
        </a>
      </li>
      <li>
        <a href="employee-master.html">
          <i class='bx bxs-message-dots bx-sm'></i>
          <span class="text">Employee</span>
        </a>
      </li>
      <li class="has-submenu" class="active">
        <a href="#" class="submenu-toggle">
          <i class='bx bxs-group bx-sm'></i>
          <span class="text">Payroll Master</span>
          <i class='bx bx-chevron-down arrow '></i>
        </a>
        <ul class="submenu" style="display: none;">
          <li><a href="salary-component.html">Salary Component</a></li>
          <li><a href="payroll.html">Payroll</a></li>
          <li><a href="fs5-master.html">FS5 Master</a></li>

        </ul>
      </li>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const submenuToggles = document.querySelectorAll('.submenu-toggle');

          submenuToggles.forEach(toggle => {
            toggle.addEventListener('click', function (e) {
              e.preventDefault();

              const parentLi = this.closest('.has-submenu');
              const submenu = parentLi.querySelector('.submenu');
              const arrow = this.querySelector('.arrow');

              // Toggle visibility
              if (submenu.style.display === 'block') {
                submenu.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
              } else {
                submenu.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
              }
            });
          });
        });
      </script>


      <li>
        <a href="user-master.html">
          <i class='bx bxs-group bx-sm'></i>
          <span class="text">User Master</span>
        </a>
      </li>
    </ul>
    <ul class="side-menu bottom">
      <!-- <li>
				<a href="#">
					<i class='bx bxs-cog bx-sm bx-spin-hover' ></i>
					<span class="text">Settings</span>
				</a>
			</li> -->
     
    </ul>
  </section>
  <!-- SIDEBAR -->



  <!-- CONTENT -->
  <section id="content">
    <!-- NAVBAR -->
    <nav>
      <i class='bx bx-menu bx-sm'></i>
      <a href="#" class="nav-link">Categories</a>
      <form action="#">
        <div class="form-input">
          <input type="search" placeholder="Search...">
          <button type="submit" class="search-btn"><i class='bx bx-search'></i></button>
        </div>
      </form>
      <input type="checkbox" class="checkbox" id="switch-mode" hidden />
      <label class="swith-lm" for="switch-mode">
        <i class="bx bxs-moon"></i>
        <i class="bx bx-sun"></i>
        <div class="ball"></div>
      </label>

      <!-- Notification Bell -->
      <a href="#" class="notification" id="notificationIcon">
        <i class='bx bxs-bell bx-tada-hover'></i>
        <span class="num">8</span>
      </a>
      <div class="notification-menu" id="notificationMenu">
        <ul>
          <li>New message from John</li>
          <li>Your order has been shipped</li>
          <li>New comment on your post</li>
          <li>Update available for your app</li>
          <li>Reminder: Meeting at 3PM</li>
        </ul>
      </div>

      <!-- Profile Menu -->
      <a href="#" class="profile" id="profileIcon">
        <img src="https://placehold.co/600x400/png" alt="Profile">
      </a>
      <div class="profile-menu" id="profileMenu">
        <ul>
          <li><a href="#">My Profile</a></li>
          <li><a href="#">Settings</a></li>
          <li id="logoutBtn"><a >Log Out</a></li>
        </ul>
      </div>
    </nav>
    <!-- NAVBAR -->


    <!-- MAIN -->
    <main>
      <div class="header-section">
        <div class="row">
          <div class="col-md-10">

            <div class="head-title">
              <div class="left">
                <h1 style="font-size: 26px;color: black;">Payroll Master</h1>
                <ul class="breadcrumb" style="padding: 0px; background: transparent;">
                  <li>
                    <a href="#">Dashboard</a>
                  </li>
                  <!-- <li><i class='bx bx-chevron-right' ></i></li> -->
                  <li>
                    <a class="active" href="#">Payroll Master</a>
                  </li>
                </ul>
              </div>
              <!-- <a href="#" class="btn-download">
                                <i class='bx bxs-cloud-download bx-fade-down-hover' ></i>
                                <span class="text">Get PDF</span>
                            </a> -->
            </div>
          </div>
          <!-- 
                    <div class="col-md-2">
                        <button type="button" class="btn btn-full btn-create " data-toggle="modal" data-target="#myModal"><i class="bi bi-plus-circle"></i> Create</button>
                    </div> -->
        </div>

      </div>




      <ul class="tab-group mt-5">
        <li class="tab active"><a href="#signup">Run Payroll</a></li>
        <li class="tab"><a href="#login">payslip</a></li>
      </ul>

      <div class="tab-content">
        <div id="signup">

          <div class="form-sec">

            <form id="Payrolrunform">
              <div class="row">

                <div class="col-md-6">
                  <label> Name</label>
                  <input type="text" id="name" class="form-control" placeholder="Enter  name" required>
                </div>


                <div class="col-md-6">
                  <label> Year</label>
                  <input type="number" id="year" class="form-control" placeholder="year" required>
                </div>

                <div class="col-md-6">
                  <label>Select Month</label>
                  <select class="form-control" id="month" name="month" required>
                    <option value="">-- Select Month --</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>


                <div class="col-md-6">
                  <label> Payment Date</label>
                  <input type="date" id="payment_date" class="form-control" placeholder="Enter  date" required>
                </div>


                <!-- <div class="col-md-6">
                  <label>Select Salary Component</label>
                  <div class="custom-sel">
                    <select class="form-control" id="components">
                      <option value="">-- Select component --</option>
                    </select>
                  </div>
                </div> -->

                <div class="col-md-6">
                  <label>Select Salary Component</label>
                  
                  <div class="multi-select-container" id="component-multi-select">
                      
                      <div class="selected-items form-control" onclick="toggleDropdown('component-list', 'component-select-box')">
                          <span id="component-select-box">-- Select component --</span>
                          <span class="arrow">‚ñº</span>
                      </div>
              
                      <div class="dropdown-list" id="component-list">
                          </div>
                  </div>
                  
                  <select class="form-control" name="components[]" id="components" multiple style="display: none;" ></select>
              
              </div>
                

             
                <!-- <div class="col-md-6">
                  <label>Select Branch</label>
                  <div class="custom-sel">
                    <select class="form-control" id="branch">
                      <option value="">-- Select Branch --</option>
                    </select>
                  </div>
                </div> -->







              </div>
              <div class=" mt-4">



                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

                <button type="submit" class="btn btn-primary">Run Payroll</button>

              </div>

            </form>

          </div>



          <div class="row mt-4">
            <div class="col-md-12">
              <div class="table-responsive">
                <table class="table table-bordered table-striped" id="payrolrunTable">
                  <thead class="thead-dark">
                    <tr>
                      <th>No</th>
                      <th>Name</th>
                      <th>Year</th>

                      <th>Month</th>
                      <th>Payment date</th>
                      <th>component</th>
                      <th>Status</th>
                      <th>Actions</th>

                    </tr>
                  </thead>
                  <tbody id="payrolrunTableBody">
                    <!-- Roles will be injected here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>

        <div id="login" class="Table_view">
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="employeeFilter">Filter by Employee:</label>
              <select id="employeeFilter" class="form-control">
                <option value="">-- All Employees --</option>
                <!-- Employee options will be populated dynamically -->
              </select>
            </div>
          </div>

          <div class="row mt-4">
            <div class="col-md-12">
              <div class="table-responsive">
                <table class="table table-bordered table-striped" id="payrolrunTable">
                  <thead class="thead-dark">
                    <tr>
                      <th>No</th>
                      <th>Employee</th>
                      <th>Payroll Name</th>
                      <th>Month</th>
                      <th>Year</th>
                      <th>Payment Date</th>
                      <th>Gross Salary</th>
                      <th>Additions</th>
                      <th>Deductions</th>
                      <th>Net Salary</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="paySlipTableBody">
                    <!-- Payslip rows will be injected here -->
                  </tbody>
                </table>
              </div>

            </div>
          </div>

        </div>



        <!-- Modal -->
        <div class="modal fade" id="myModal" role="dialog">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">

              <div class="modal-body">
                <div class="row">
                  <div class="col-md-10">
                    <h4>Payslip Details</h4>
                  </div>
              
                   
                  <div class="col-md-2 text-right">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                  </div>
                </div>
                <hr>

             
                <div class="patslipdetlais">
                <!-- üü° You must include this -->
                <div id="payslipContent">

                  <div id="payslipDetails">

                    <!-- Payslip data will be injected here -->
                  </div>
                </div>


                <div class="row">
                  <div class="col-md-10"></div>

                  <div class="col-md-2">
                    <button type="button" class="btn btn-download btn-danger mt-3">Download</button>
                  </div>
                </div>
                <div class="mt-4"></div>
</div>
              </div>
            </div>
          </div>
        </div>


        <script>
          document.addEventListener("DOMContentLoaded", function () {
  // Get elements
  const fs5Button = document.getElementById("btnDownloadFS5");
  const backButton = document.getElementById("btnBackToPayslip");
  const fs5FormatDiv = document.querySelector(".fs5format");
  const payslipDetailsDiv = document.querySelector(".patslipdetlais");

  // Hide FS5 format initially
  fs5FormatDiv.style.display = "none";

  // üü¢ FS5 Button Click ‚Üí Show FS5 Format
  fs5Button.addEventListener("click", function () {
    fs5FormatDiv.style.display = "block";
    payslipDetailsDiv.style.display = "none";
  });

  // üü¢ Back Button Click ‚Üí Show Payslip Details Again
  backButton.addEventListener("click", function () {
    fs5FormatDiv.style.display = "none";
    payslipDetailsDiv.style.display = "block";
  });
});

        </script>


        <script>
          document.querySelector('.btn-download').addEventListener('click', function () {
            const element = document.getElementById('payslipContent');

            const opt = {
              margin: 0.5,
              filename: 'payslip.pdf',
              image: { type: 'jpeg', quality: 0.98 },
              html2canvas: { scale: 2 },
              jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
          });
        </script>



      </div><!-- tab-content -->









      <script>
        $('.form').find('input, textarea').on('keyup blur focus', function (e) {

          var $this = $(this),
            label = $this.prev('label');

          if (e.type === 'keyup') {
            if ($this.val() === '') {
              label.removeClass('active highlight');
            } else {
              label.addClass('active highlight');
            }
          } else if (e.type === 'blur') {
            if ($this.val() === '') {
              label.removeClass('active highlight');
            } else {
              label.removeClass('highlight');
            }
          } else if (e.type === 'focus') {

            if ($this.val() === '') {
              label.removeClass('highlight');
            }
            else if ($this.val() !== '') {
              label.addClass('highlight');
            }
          }

        });

        $('.tab a').on('click', function (e) {

          e.preventDefault();

          $(this).parent().addClass('active');
          $(this).parent().siblings().removeClass('active');

          target = $(this).attr('href');

          $('.tab-content > div').not(target).hide();

          $(target).fadeIn(600);

        });
      </script>





<script>
  // ================== Dynamic API Base ==================
  const API_BASE_URL =
    window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost"
      ? "http://127.0.0.1:8001"
      : "http://84.247.143.75"; // live server

  const token = localStorage.getItem("access_token");

  let allPayslips = []; // to store all payslips globally


   // ================== Load Employee Dropdown ==================
  function loadEmployeeDropdown() {
    fetch(`${API_BASE_URL}/employee/employee/`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    })
      .then((res) => res.json())
      .then((employees) => {
        const select = document.getElementById("employeeFilter");
        select.innerHTML = `<option value="">-- All Employees --</option>`;
        employees.forEach((emp) => {
          const opt = document.createElement("option");
          opt.value = emp.id;
          opt.textContent = `${emp.first_name} (${emp.emp_code})`;
          select.appendChild(opt);
        });
      })
      .catch((err) => console.error("Error loading employees:", err));
  }

  // ================== GET Payslip List ==================
 // ================== Fetch Payslip List ==================
 function loadPayslips() {
    fetch(`${API_BASE_URL}/employee/payslip/`, {
      method: "GET",
      headers: {
        Authorization: `Bearer ${token}`,
        "Content-Type": "application/json",
      },
    })
      .then((res) => res.json())
      .then((payslips) => {
        allPayslips = payslips; // save globally
        renderPayslips(payslips); // show all initially
      })
      .catch((err) => console.error("Error fetching payslip data:", err));
  }

  // ================== Render Payslips to Table ==================
  function renderPayslips(payslips) {
    const tableBody = document.getElementById("paySlipTableBody");
    tableBody.innerHTML = "";

    const monthNames = [
      "", "Jan", "Feb", "Mar", "Apr", "May", "Jun",
      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    ];

    payslips.forEach((item, index) => {
      const payroll = item.payroll_run;
      const row = `
        <tr class="payslip-row" data-id="${item.id}">
          <td>${index + 1}</td>
          <td>${item.employee?.first_name} (${item.employee?.emp_code})</td>
          <td>${payroll?.name || '-'}</td>
          <td>${monthNames[payroll?.month] || '-'}</td>
          <td>${payroll?.year || '-'}</td>
          <td>${payroll?.payment_date || '-'}</td>
          <td>${item.gross_salary}</td>
          <td>${item.total_additions}</td>
          <td>${item.total_deductions}</td>
          <td>${item.net_salary}</td>
          <td>${item.status}</td>
        </tr>`;
      tableBody.insertAdjacentHTML("beforeend", row);
    });
  }

  // ================== Employee Filter Logic ==================
  document.addEventListener("change", function (e) {
    if (e.target.id === "employeeFilter") {
      const selectedEmpId = e.target.value;
      if (selectedEmpId === "") {
        renderPayslips(allPayslips); // show all
      } else {
        const filtered = allPayslips.filter(
          (p) => p.employee && p.employee.id === parseInt(selectedEmpId)
        );
        renderPayslips(filtered);
      }
    }
  });

  // ================== Payslip Details Modal ==================
  document.addEventListener("click", function (e) {
    if (e.target.closest(".payslip-row")) {
      const row = e.target.closest(".payslip-row");
      const payslipId = row.getAttribute("data-id");
      openPayslipModal(payslipId);
    }
  });

  function openPayslipModal(payslipId) {
    fetch(`${API_BASE_URL}/employee/payslip/${payslipId}/`, {
      method: "GET",
      headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
    })
      .then((res) => res.json())
      .then((payslip) => {
        const payroll = payslip.payroll_run;
        const emp = payslip.employee;
        const company = emp.company;

      
    const html = `
<style>
.payslip-box {
font-family: Arial, sans-serif;
font-size: 14px;
color: #000;
}
.payslip-title {
color: #8B0000;
font-weight: bold;
font-size: 22px;
text-align: left;
margin-bottom: 10px;
}
.main-heading {
font-size: 22px;
font-weight: bold;
text-align: center;
margin: 10px 0;
}
.row-flex {
display: flex;
justify-content: space-between;
flex-wrap: wrap;
margin-bottom: 10px;
}
.bordered {
border: 1px solid #000;
padding: 5px;
margin-bottom: 10px;
white-space: pre-line;
    

}
.half {
width: 48%;
}
.payslip-table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
}
.payslip-table td, .payslip-table th {
border: 1px solid #000;
padding: 6px;
}
.payslip-table th {
background-color: #eee;
}
.section-label {
margin-top: 20px;
border-top: 2px solid #8B0000;
padding-top: 10px;
font-weight: bold;
font-size: 16px;
color: #8B0000;
}

.row-flex {
display: flex;
align-items: center;
justify-content: flex-start; /* align left */
margin-bottom: 6px;
}
.bordered {
border: 1px solid #000;
padding: 4px 8px;
text-align: left;
display: inline-block;
}

</style>

<div class="payslip-box">
<div class="payslip-title">Pay Slip</div>

<div class="row">

<div class="col-md-6">
    <div class="main-heading">${company.employer_name?.toUpperCase()}</div>

  </div>

   <div class="col-md-6">
    
<div >
<div><strong>Month:</strong> ${payroll.name}-${payroll.year}</div>
<div class="row-flex">
<div><strong>From:</strong> 01-${payroll.name}-${payroll.year}</div>
<div><strong>To:</strong> ${payroll.payment_date}</div>
</div>
</div>
  </div>
</div><hr style="color:red;border:solid 1.5px #8B0000">



<!-- Employer Details -->
<div class="row-flex" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000;">Employer‚Äôs Name:</div>
<div class="bordered" style="width: 35%;margin-bottom:0px"><strong>${company.name?.toUpperCase()}</strong></div>
</div>

<div class="row-flex" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000">Address:</div>
<div class="bordered" style="width: 35%; margin-bottom:0px"><strong>${company.address}</strong></div>
</div>



<!-- Employee Details -->
<div class="row-flex mt-5" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000"">Employee‚Äôs Name:</div>
<div class="bordered" style="width: 35%;margin-bottom:0px"><strong>${emp.first_name?.toUpperCase()} ${emp.last_name?.toUpperCase()}</strong></div>
</div>
<div class="row-flex" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000"">Type of Employment:</div>
<div class="bordered" style="width: 35%;margin-bottom:0px"><strong>${emp.type_of_employment || '-'}</strong></div>
</div>
<div class="row-flex" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000"">ID No.:</div>
<div class="bordered" style="width: 35%;margin-bottom:0px">${emp.emp_code}</div>
</div>
<div class="row-flex" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000"">Social Security No.:</div>
<div class="bordered" style="width: 35%;margin-bottom:0px">${emp.social_security_no}</div>
</div>
<div class="row-flex" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000"">Category:</div>
<div class="bordered" style="width: 35%;margin-bottom:0px">${emp.category?.name || '-'}</div>
</div>

<div class="row-flex" style="margin-bottom:0px">
<div style="width: 25%;color:#8B0000"">Address:</div>
<div class="bordered" style="width: 35%;margin-bottom:0px">${emp.address || '-'}</div>
</div>
<hr style="color:red;border:solid 1.5px #8B0000">

<!-- Earnings Section -->

${payslip.components && payslip.components.length > 0
                  ? (
                    // Split additions and deductions
                    (() => {
                      const additions = payslip.components.filter(c => c.component_type === "addition");
                      const deductions = payslip.components.filter(c => c.component_type === "deduction");

                      // Render additions
                      const additionHtml = additions.map(comp => `
        <div class="row-flex" style="margin-bottom:0px">
          <div style="width: 25%;color:#8B0000">${comp.component_name}</div>
          <div class="bordered" style="width: 35%;margin-bottom:0px">‚Ç¨${comp.amount}</div>
        </div>
      `).join('');

                      // Render deductions
                      const deductionHtml = deductions.map(comp => `
        <div class="row-flex" style="margin-bottom:0px">
          <div style="width: 25%;color:#8B0000">${comp.component_name}</div>
          <div class="bordered" style="width: 35%;margin-bottom:0px">‚Ç¨${comp.amount}</div>
        </div>
      `).join('');

                      // Return full block (additions -> gross -> deductions -> net)
                      return `
        ${additionHtml}

        <div class="row-flex mt-4">
          <div style="width: 25%;color:#8B0000;text-align:center;"><strong>Gross Salary</strong></div>
          <div class="bordered" style="width: 35%;"><strong>‚Ç¨${payslip.gross_salary}</strong></div>
        </div>

        ${deductionHtml}

        <div class="row-flex mt-4">
          <div style="width: 25%;color:#8B0000;text-align:center;"><strong>Net Salary</strong></div>
          <div class="bordered" style="width: 35%; border-bottom:solid 3px;"><strong>‚Ç¨${payslip.net_salary}</strong></div>
        </div>
      `;
                    })()
                  )
                  : '<div class="row-flex"><div style="width: 25%;"><strong>Components</strong></div><div class="bordered" style="width: 35%;">No components available</div></div>'
                }
<hr style="color:red;border:solid 1.5px #8B0000">



</div>

`;


        document.getElementById("payslipDetails").innerHTML = html;
        $("#myModal").modal("show");
      })
      .catch((err) => {
        console.error("Error loading payslip details:", err);
        alert("Failed to load payslip details.");
      });
  }

 // ================== CRUD Payroll Run ==================

  // Load Payroll Runs (Read)
  function loadPayrollRuns() {
    fetch(`${API_BASE_URL}/employee/PayrollRun/`, {
      method: "GET",
      headers: { Authorization: `Bearer ${token}` },
    })
      .then((res) => res.json())
      .then((runs) => {
        const tableBody = document.getElementById("payrolrunTableBody");
        if (!tableBody) return;
        tableBody.innerHTML = "";

        runs.forEach((run, index) => {
          const compNames = run.components?.map(c => c.name).join(", ") || "N/A";
          const row = `
            <tr>
              <td>${index + 1}</td>
              <td>${run.name || "N/A"}</td>
              <td>${run.year || "N/A"}</td>
              <td>${run.month || "N/A"}</td>
              <td>${run.payment_date || "N/A"}</td>
              <td>${compNames}</td>
              <td>${run.status || "N/A"}</td>
              <td>
                <button onclick="editPayrollRun(${run.id})" class="btn btn-sm btn-warning">‚úèÔ∏è Edit</button>
                <button onclick="deletePayrollRun(${run.id})" class="btn btn-sm btn-danger">üóë Delete</button>
              </td>
            </tr>`;
          tableBody.insertAdjacentHTML("beforeend", row);
        });
      })
      .catch((err) => console.error("Error fetching payroll runs:", err));
  }
  document.addEventListener("DOMContentLoaded", loadPayrollRuns);


   // ================== FS5 Download (NEW) ==================
 document.addEventListener("DOMContentLoaded", function () {
    const btnGetFS5 = document.getElementById("btn-get-fs5");
    const fs5YearInput = document.getElementById("fs5_year");
    const fs5MonthSelect = document.getElementById("fs5_month");

    if (!btnGetFS5) return; // prevent errors if FS5 section not on page

    btnGetFS5.addEventListener("click", function () {
      const year = fs5YearInput.value;
      const month = fs5MonthSelect.value;

      if (!year || !month) {
        alert("‚ö†Ô∏è Please select both Year and Month");
        return;
      }

      btnGetFS5.disabled = true;
      btnGetFS5.textContent = "Downloading...";

      const url = `${API_BASE_URL}/employee/payslip/download-fs5/?month=${month}&year=${year}`;

      fetch(url, {
        method: "GET",
        headers: { Authorization: `Bearer ${token}` },
      })
        .then((res) => {
          if (!res.ok) throw new Error("Failed to download FS5");
          return res.blob();
        })
        .then((blob) => {
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = downloadUrl;
          a.download = `FS5_${month}_${year}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(downloadUrl);
          alert(`‚úÖ FS5 for ${month}/${year} downloaded successfully!`);
        })
        .catch((err) => {
          console.error("Error downloading FS5:", err);
          alert("‚ùå Failed to download FS5. Please try again.");
        })
        .finally(() => {
          btnGetFS5.disabled = false;
          btnGetFS5.textContent = "Get FS5";
        });
    });
  });


  
// Function to get all selected values from the multi-select <select> element
  function getSelectedComponentIds() {
    const selectElement = document.getElementById("components");
    // Get all SELECTED options
    const selectedOptions = Array.from(selectElement.options).filter(option => option.selected);
    
    // Map their values to integers (the IDs the API expects)
    return selectedOptions.map(option => parseInt(option.value)).filter(id => !isNaN(id));
}

// Function to toggle the visibility of the dropdown list
function toggleDropdown(listId, boxId) {
    const dropdown = document.getElementById(listId);
    const selectBox = document.getElementById(boxId).parentElement; 
    
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    selectBox.classList.toggle('active');
}

// Function to handle the "Select All" checkbox
function handleSelectAll(selectAllCheckbox, listId, selectId) {
    const isChecked = selectAllCheckbox.checked;
    const allCheckboxes = document.querySelectorAll(`#${listId} input[type="checkbox"]`);
    
    // Set all checkboxes (including 'Select All') to the same state
    allCheckboxes.forEach(cb => {
        cb.checked = isChecked;
    });
    
    // CRITICAL: Call the synchronization function after changing all states
    updateSelected(listId, selectId);
}

// CRITICAL SYNCHRONIZATION FUNCTION
function updateSelected(listId, selectId) {
  const dropdownList = document.getElementById(listId);
  const selectElement = document.getElementById(selectId);
  const selectedTextBox = document.getElementById("component-select-box"); // ‚úÖ fixed target

  let selectedText = [];

  // 1Ô∏è‚É£ Clear previous selections in hidden <select>
  Array.from(selectElement.options).forEach(option => option.selected = false);

  // 2Ô∏è‚É£ Find all checked checkboxes
  const checkboxes = dropdownList.querySelectorAll('input[type="checkbox"]:checked');

  if (checkboxes.length === 0) {
    selectedTextBox.textContent = '-- Select component --';
  } else {
    checkboxes.forEach(cb => {
      const val = cb.value;
      const name = cb.getAttribute('data-name');

      if (val !== "all") {
        const option = selectElement.querySelector(`option[value="${val}"]`);
        if (option) option.selected = true; // ‚úÖ correctly syncs with hidden <select>
      }

      if (val === "all") {
        selectedText = ["All Components Selected"];
      } else {
        selectedText.push(name);
      }
    });

    if (selectedText.includes("All Components Selected")) {
      selectedTextBox.textContent = "All Components Selected";
    } else if (selectedText.length > 3) {
      selectedTextBox.textContent = `${selectedText.length} Components Selected`;
    } else {
      selectedTextBox.textContent = selectedText.join(", ");
    }
  }

  // 3Ô∏è‚É£ Update "Select All" checkbox state
  const selectAllCheckbox = dropdownList.querySelector('input[value="all"]');
  const allOptionCheckboxes = dropdownList.querySelectorAll('input[type="checkbox"]:not([value="all"])');
  const allChecked = Array.from(allOptionCheckboxes).every(cb => cb.checked);
  if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
}

// Close the dropdown if the user clicks outside
document.addEventListener('click', function(event) {
    const container = document.getElementById('component-multi-select');
    if (container && !container.contains(event.target)) {
        document.getElementById('component-list').style.display = 'none';
        document.querySelector('.selected-items').classList.remove('active');
    }
});
// ‚úÖ Load Components Dropdown (Dynamic Linking Check)
function loadComponentDropdown() {
    fetch(`${API_BASE_URL}/employee/salarycomponent/`, {
        headers: { Authorization: `Bearer ${token}` },
    })
    .then((res) => res.json())
    .then((components) => {
        const selectElement = document.getElementById("components");
        const listContainer = document.getElementById("component-list");

        // Clear previous options/list items
        selectElement.innerHTML = '';
        listContainer.innerHTML = '';

        // --- 1. Add "Select All" (Linked to handleSelectAll) ---
        const selectAllLabel = document.createElement('label');
        selectAllLabel.innerHTML = `
            <input type="checkbox" value="all" data-name="Select All" 
                   onchange="handleSelectAll(this, 'component-list', 'components')"> 
            Select All
        `;
        listContainer.appendChild(selectAllLabel);


        // --- 2. Create options and checkboxes (Linked to updateSelected) ---
        components.forEach((comp) => {
            // Hidden <option>
            const opt = document.createElement("option");
            opt.value = comp.id;
            opt.textContent = comp.name;
            selectElement.appendChild(opt);

            // Visible checkbox (CRITICAL: Links to updateSelected)
            const label = document.createElement('label');
            label.innerHTML = `
                <input type="checkbox" value="${comp.id}" data-name="${comp.name}"
                       onchange="updateSelected('component-list', 'components')"> 
                ${comp.name}
            `;
            listContainer.appendChild(label);
        });
        
        // Ensure the initial display text is set
        document.getElementById("component-select-box").textContent = '-- Select component --';
    });
}




// ‚úÖ Create Payroll Run (Submission Handler)
document.getElementById("Payrolrunform").addEventListener("submit", function (e) {
    e.preventDefault();

    // 1. Get the array of selected component IDs from the SYNCHRONIZED hidden select
    const selectedComponentIds = getSelectedComponentIds();

    // 2. Validation Check
    if (selectedComponentIds.length === 0) {
        alert("‚ùå Please select at least one Salary Component.");
        // Open the dropdown for better UX
        document.getElementById('component-list').style.display = 'block';
        document.getElementById('component-select-box').parentElement.classList.add('active');
        return; 
    }
    
    // 3. If valid, build the final payload
    const data = {
        name: document.getElementById("name").value,
        year: parseInt(document.getElementById("year").value),
        month: parseInt(document.getElementById("month").value),
        payment_date: document.getElementById("payment_date").value,
        components: selectedComponentIds, // This will now be [ID1, ID2, ...]
    };

    console.log("Payload to API:", data);

    // 4. Proceed with the API call
    fetch(`${API_BASE_URL}/employee/PayrollRun/`, {
        method: "POST",
        headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
        body: JSON.stringify(data),
    })
    // ... rest of your .then().catch() chain ...
    // (Ensure you also include the necessary multi-select utility functions: getSelectedComponentIds, toggleDropdown, etc.)
});

  // ‚úÖ Update Payroll Run
  function editPayrollRun(id) {
    fetch(`${API_BASE_URL}/employee/PayrollRun/${id}/`, {
      method: "GET",
      headers: { Authorization: `Bearer ${token}` },
    })
      .then((res) => res.json())
      .then((run) => {
        document.getElementById("name").value = run.name;
        document.getElementById("year").value = run.year;
        document.getElementById("month").value = run.month;
        document.getElementById("payment_date").value = run.payment_date;

        if (run.components && run.components.length > 0) {
          document.getElementById("components").value = run.components[0].id;
        }

        const form = document.getElementById("Payrolrunform");
        form.onsubmit = function (e) {
    e.preventDefault();

    // üåü FIX: Get the array of selected component IDs
    const selectedComponentIds = getSelectedComponentIds(); 

    const updatedData = {
        name: document.getElementById("name").value,
        year: parseInt(document.getElementById("year").value),
        month: parseInt(document.getElementById("month").value),
        payment_date: document.getElementById("payment_date").value,
        // üåü FIX: Use the array of IDs instead of the string value
        components: selectedComponentIds,
    };

          fetch(`${API_BASE_URL}/employee/PayrollRun/${id}/`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", Authorization: `Bearer ${token}` },
            body: JSON.stringify(updatedData),
          })
            .then((res) => res.json())
            .then(() => {
              alert("‚úÖ Payroll Run updated");
              form.reset();
              form.onsubmit = null;
              loadPayrollRuns();
            })
            .catch(() => alert("‚ùå Failed to update payroll run"));
        };
      });
  }

  // ‚úÖ Delete Payroll Run
  function deletePayrollRun(id) {
    if (!confirm("Delete this payroll run?")) return;

    fetch(`${API_BASE_URL}/employee/PayrollRun/${id}/`, {
      method: "DELETE",
      headers: { Authorization: `Bearer ${token}` },
    })
      .then((res) => {
        if (res.status === 204) {
          alert("üóë Payroll Run deleted");
          loadPayrollRuns();
        } else {
          alert("‚ùå Failed to delete payroll run");
        }
      })
      .catch(() => alert("‚ùå Error deleting payroll run"));
  }



// ================== INIT ==================
  document.addEventListener("DOMContentLoaded", function () {
    loadComponentDropdown();
    loadEmployeeDropdown();
    loadPayslips();
  });


</script>



  <script>
    const detailDiv = document.getElementById("payslipDetails");
    if (!detailDiv) {
      console.error("‚ùå #payslipDetails element not found in DOM.");
      return;
    }
    detailDiv.innerHTML = html;
  </script>



    </main>
    <!-- MAIN -->
  </section>
  <!-- CONTENT -->







  <script>
    document.getElementById('logoutBtn').addEventListener('click', function (e) {
      e.preventDefault();
  
      // Remove only specific session data
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token'); // if you use one
      localStorage.removeItem('user_id');       // if stored
  
      // OR clear everything (if you don‚Äôt store other important data)
      // localStorage.clear();
  
      // Redirect to login page
      window.location.href = 'login.html';  
    });
  </script>
  

  <!-- JavaScript -->






  <script src="script.js"></script>
</body>

</html>

<script>
  const allSideMenu = document.querySelectorAll('#sidebar .side-menu.top li a');

  allSideMenu.forEach(item => {
    const li = item.parentElement;

    item.addEventListener('click', function () {
      allSideMenu.forEach(i => {
        i.parentElement.classList.remove('active');
      })
      li.classList.add('active');
    })
  });

  // TOGGLE SIDEBAR
  const menuBar = document.querySelector('#content nav .bx.bx-menu');
  const sidebar = document.getElementById('sidebar');

  // Sidebar toggle i≈ülemi
  menuBar.addEventListener('click', function () {
    sidebar.classList.toggle('hide');
  });

  // Sayfa y√ºklendiƒüinde ve boyut deƒüi≈üimlerinde sidebar durumunu ayarlama
  function adjustSidebar() {
    if (window.innerWidth <= 576) {
      sidebar.classList.add('hide');  // 576px ve altƒ± i√ßin sidebar gizli
      sidebar.classList.remove('show');
    } else {
      sidebar.classList.remove('hide');  // 576px'den b√ºy√ºkse sidebar g√∂r√ºn√ºr
      sidebar.classList.add('show');
    }
  }

  // Sayfa y√ºklendiƒüinde ve pencere boyutu deƒüi≈ütiƒüinde sidebar durumunu ayarlama
  window.addEventListener('load', adjustSidebar);
  window.addEventListener('resize', adjustSidebar);

  // Arama butonunu toggle etme
  const searchButton = document.querySelector('#content nav form .form-input button');
  const searchButtonIcon = document.querySelector('#content nav form .form-input button .bx');
  const searchForm = document.querySelector('#content nav form');

  searchButton.addEventListener('click', function (e) {
    if (window.innerWidth < 768) {
      e.preventDefault();
      searchForm.classList.toggle('show');
      if (searchForm.classList.contains('show')) {
        searchButtonIcon.classList.replace('bx-search', 'bx-x');
      } else {
        searchButtonIcon.classList.replace('bx-x', 'bx-search');
      }
    }
  })

  // Dark Mode Switch
  const switchMode = document.getElementById('switch-mode');

  switchMode.addEventListener('change', function () {
    if (this.checked) {
      document.body.classList.add('dark');
    } else {
      document.body.classList.remove('dark');
    }
  })

  // Notification Menu Toggle
  document.querySelector('.notification').addEventListener('click', function () {
    document.querySelector('.notification-menu').classList.toggle('show');
    document.querySelector('.profile-menu').classList.remove('show'); // Close profile menu if open
  });

  // Profile Menu Toggle
  document.querySelector('.profile').addEventListener('click', function () {
    document.querySelector('.profile-menu').classList.toggle('show');
    document.querySelector('.notification-menu').classList.remove('show'); // Close notification menu if open
  });

  // Close menus if clicked outside
  window.addEventListener('click', function (e) {
    if (!e.target.closest('.notification') && !e.target.closest('.profile')) {
      document.querySelector('.notification-menu').classList.remove('show');
      document.querySelector('.profile-menu').classList.remove('show');
    }
  });

  // Men√ºlerin a√ßƒ±lƒ±p kapanmasƒ± i√ßin fonksiyon
  function toggleMenu(menuId) {
    var menu = document.getElementById(menuId);
    var allMenus = document.querySelectorAll('.menu');

    // Diƒüer t√ºm men√ºleri kapat
    allMenus.forEach(function (m) {
      if (m !== menu) {
        m.style.display = 'none';
      }
    });

    // Tƒ±klanan men√º varsa a√ß, yoksa kapat
    if (menu.style.display === 'none' || menu.style.display === '') {
      menu.style.display = 'block';
    } else {
      menu.style.display = 'none';
    }
  }

  // Ba≈ülangƒ±√ßta t√ºm men√ºleri kapalƒ± tut
  document.addEventListener("DOMContentLoaded", function () {
    var allMenus = document.querySelectorAll('.menu');
    allMenus.forEach(function (menu) {
      menu.style.display = 'none';
    });
  });
</script>